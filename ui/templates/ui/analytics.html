{% extends "ui/base.html" %}
{% block title %}–ê–Ω–∞–ª–∏—Ç–∏–∫–∞{% endblock %}

{% block content %}
<style>
  .soft-card { border: 1px solid rgba(255,255,255,.08); border-radius: 16px; }
  .soft-card .card-header { background: rgba(255,255,255,.03); border-bottom: 1px solid rgba(255,255,255,.08); }
  .badge-soft { background: rgba(13,110,253,.12); color: #9ec5fe; border: 1px solid rgba(13,110,253,.25); }
  .badge-soft-muted { background: rgba(255,255,255,.06); border: 1px solid rgba(255,255,255,.08); }
  .btn-icon { display: inline-flex; align-items: center; gap: .4rem; }
  .form-hint { font-size: .875rem; opacity: .75; }
  .nav-tabs .nav-link { border-top-left-radius: 14px; border-top-right-radius: 14px; }
  .table thead th { font-weight: 600; }
  .table tbody tr:hover { transform: translateY(-1px); transition: .12s ease; }
  .kpi { padding: 1rem; border-radius: 16px; border: 1px solid rgba(255,255,255,.08); background: rgba(255,255,255,.03); }
  .kpi .label { font-size: .85rem; opacity: .75; }
  .kpi .value { font-size: 1.35rem; font-weight: 700; letter-spacing: .2px; }
  .empty-state { padding: 2.25rem 1rem; text-align: center; }
  .empty-state .icon { font-size: 2rem; opacity: .7; }
</style>

<div class="d-flex align-items-center justify-content-between mb-3">
  <div>
    <h4 class="m-0">–ê–Ω–∞–ª–∏—Ç–∏–∫–∞</h4>
    <div class="form-hint">–ü–µ—Ä–∏–æ–¥, –º–∞–≥–∞–∑–∏–Ω –∏ —Å–≤–æ–¥–∫–∏ –ø–æ –≤—ã—Ä—É—á–∫–µ</div>
  </div>

  <div class="d-flex gap-2 align-items-center">
    <span class="badge rounded-pill badge-soft-muted">
      {{ from }} ‚Äî {{ to }}
    </span>
    {% if magazins %}
      <span class="badge rounded-pill badge-soft">
        {% if selected_magazin == 0 %}–í—Å–µ –º–∞–≥–∞–∑–∏–Ω—ã{% else %}–ú–∞–≥–∞–∑–∏–Ω #{{ selected_magazin }}{% endif %}
      </span>
    {% endif %}
  </div>
</div>

<div class="card soft-card shadow-sm mb-3">
  <div class="card-header py-3">
    <div class="d-flex flex-wrap align-items-center justify-content-between gap-2">
      <div class="d-flex align-items-center gap-2">
        <span class="badge rounded-pill badge-soft">–§–∏–ª—å—Ç—Ä—ã</span>
        <span class="badge rounded-pill badge-soft-muted">tab: {{ tab }}</span>
      </div>
      <a class="btn btn-outline-secondary btn-sm btn-icon" href="{% url 'analytics' %}">
        <span aria-hidden="true">‚Ü©Ô∏è</span><span>–°–±—Ä–æ—Å–∏—Ç—å</span>
      </a>
    </div>
  </div>

  <div class="card-body">
    <form class="row g-2" method="get">
      <input type="hidden" name="tab" value="{{ tab }}">

      <div class="col-md-3">
        <label class="form-label">–°</label>
        <input class="form-control" type="date" name="from" value="{{ from }}">
      </div>

      <div class="col-md-3">
        <label class="form-label">–ü–æ</label>
        <input class="form-control" type="date" name="to" value="{{ to }}">
      </div>

      {% if magazins %}
      <div class="col-md-4">
        <label class="form-label">–ú–∞–≥–∞–∑–∏–Ω</label>
        <select class="form-select" name="magazin">
          <option value="0" {% if selected_magazin == 0 %}selected{% endif %}>–í—Å–µ –º–∞–≥–∞–∑–∏–Ω—ã</option>
          {% for m in magazins %}
            <option value="{{ m.id }}" {% if selected_magazin == m.id %}selected{% endif %}>{{ m.nazvanie }}</option>
          {% endfor %}
        </select>
      </div>
      {% endif %}

      <div class="col-md-2 d-grid align-items-end">
        <button class="btn btn-primary btn-icon mt-4">
          <span aria-hidden="true">üìä</span><span>–ü–æ–∫–∞–∑–∞—Ç—å</span>
        </button>
      </div>
    </form>
  </div>
</div>

<div class="d-flex flex-wrap align-items-center justify-content-between gap-2 mb-3">
  <ul class="nav nav-tabs">
    <li class="nav-item">
      <a class="nav-link {% if tab == 'daily' %}active{% endif %}"
         href="?tab=daily&from={{ from }}&to={{ to }}{% if magazins %}&magazin={{ selected_magazin }}{% endif %}">
        –î–∏–Ω–∞–º–∏–∫–∞
      </a>
    </li>
    <li class="nav-item">
      <a class="nav-link {% if tab == 'stores' %}active{% endif %}"
         href="?tab=stores&from={{ from }}&to={{ to }}{% if magazins %}&magazin={{ selected_magazin }}{% endif %}">
        –ü–æ –º–∞–≥–∞–∑–∏–Ω–∞–º
      </a>
    </li>
    <li class="nav-item">
      <a class="nav-link {% if tab == 'sellers' %}active{% endif %}"
         href="?tab=sellers&from={{ from }}&to={{ to }}{% if magazins %}&magazin={{ selected_magazin }}{% endif %}">
        –ü–æ –ø—Ä–æ–¥–∞–≤—Ü–∞–º
      </a>
    </li>
  </ul>

  <a class="btn btn-outline-secondary btn-sm btn-icon"
     href="{% url 'analytics_export_csv' %}?mode={{ tab }}&from={{ from }}&to={{ to }}{% if magazins %}&magazin={{ selected_magazin }}{% endif %}">
    <span aria-hidden="true">‚¨áÔ∏è</span><span>CSV</span>
  </a>
</div>

{% if tab == "daily" %}
  <div class="row g-3 mb-3">
    <div class="col-md-4">
      <div class="kpi">
        <div class="label">–°—É–º–º–∞ –∑–∞ –ø–µ—Ä–∏–æ–¥</div>
        <div class="value">{{ total_sum }}</div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="kpi">
        <div class="label">–°—Ä–µ–¥–Ω–µ–µ –≤ –¥–µ–Ω—å</div>
        <div class="value">{{ avg_day }}</div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="kpi">
        <div class="label">–î–Ω–µ–π –≤ –≤—ã–±–æ—Ä–∫–µ</div>
        <div class="value">{{ daily|length }}</div>
      </div>
    </div>
  </div>

  <div class="card soft-card shadow-sm mb-4">
    <div class="card-header py-3 d-flex align-items-center justify-content-between">
      <div class="d-flex align-items-center gap-2">
        <span class="badge rounded-pill badge-soft">–ì—Ä–∞—Ñ–∏–∫</span>
        <span class="text-muted">–í—ã—Ä—É—á–∫–∞ –ø–æ –¥–Ω—è–º</span>
      </div>
    </div>
    <div class="card-body">
      <canvas id="revChart" height="90"></canvas>
    </div>
  </div>

  <div class="row g-3">
    <div class="col-md-6">
      <div class="card soft-card shadow-sm">
        <div class="card-header py-3">
          <div class="d-flex align-items-center gap-2">
            <span class="badge rounded-pill badge-soft">–¢–æ–ø</span>
            <span class="text-muted">–ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É</span>
          </div>
        </div>
        <div class="card-body">
          <table class="table table-sm align-middle">
            <thead><tr><th>–¢–æ–≤–∞—Ä</th><th class="text-end">–ö–æ–ª-–≤–æ</th></tr></thead>
            <tbody>
            {% for r in top_qty %}
              <tr>
                <td class="fw-semibold">{{ r.id_tovar__nazvanie }}</td>
                <td class="text-end fw-semibold">{{ r.qty }}</td>
              </tr>
            {% empty %}
              <tr>
                <td colspan="2">
                  <div class="empty-state">
                    <div class="icon" aria-hidden="true">üßæ</div>
                    <div class="fw-semibold mt-2">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div>
                    <div class="text-muted">–ü–æ–ø—Ä–æ–±—É–π —Ä–∞—Å—à–∏—Ä–∏—Ç—å –ø–µ—Ä–∏–æ–¥</div>
                  </div>
                </td>
              </tr>
            {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="col-md-6">
      <div class="card soft-card shadow-sm">
        <div class="card-header py-3">
          <div class="d-flex align-items-center gap-2">
            <span class="badge rounded-pill badge-soft">–¢–æ–ø</span>
            <span class="text-muted">–ø–æ —Å—É–º–º–µ</span>
          </div>
        </div>
        <div class="card-body">
          <table class="table table-sm align-middle">
            <thead><tr><th>–¢–æ–≤–∞—Ä</th><th class="text-end">–°—É–º–º–∞</th></tr></thead>
            <tbody>
            {% for r in top_amount %}
              <tr>
                <td class="fw-semibold">{{ r.id_tovar__nazvanie }}</td>
                <td class="text-end fw-semibold">{{ r.amount }}</td>
              </tr>
            {% empty %}
              <tr>
                <td colspan="2">
                  <div class="empty-state">
                    <div class="icon" aria-hidden="true">üßæ</div>
                    <div class="fw-semibold mt-2">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div>
                    <div class="text-muted">–ü–æ–ø—Ä–æ–±—É–π —Ä–∞—Å—à–∏—Ä–∏—Ç—å –ø–µ—Ä–∏–æ–¥</div>
                  </div>
                </td>
              </tr>
            {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    const labels = {{ labels|safe }};
    const values = {{ values|safe }};
    const ctx = document.getElementById("revChart");

    new Chart(ctx, {
      type: "line",
      data: {
        labels: labels,
        datasets: [{
          label: "–í—ã—Ä—É—á–∫–∞ –ø–æ –¥–Ω—è–º",
          data: values,
          tension: 0.25,
          fill: true
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { display: true }
        },
        scales: {
          y: { beginAtZero: true },
          x: { ticks: { maxRotation: 0 } }
        }
      }
    });
  </script>

{% elif tab == "stores" %}
  <div class="card soft-card shadow-sm">
    <div class="card-header py-3 d-flex align-items-center justify-content-between">
      <div class="d-flex align-items-center gap-2">
        <span class="badge rounded-pill badge-soft">–°–≤–æ–¥–∫–∞</span>
        <span class="text-muted">–≤—ã—Ä—É—á–∫–∞ –ø–æ –º–∞–≥–∞–∑–∏–Ω–∞–º</span>
      </div>
    </div>
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-hover table-sm align-middle mb-0">
          <thead>
            <tr>
              <th class="ps-3">–ú–∞–≥–∞–∑–∏–Ω</th>
              <th class="text-end">–ß–µ–∫–æ–≤</th>
              <th class="text-end">–ö–æ–ª-–≤–æ</th>
              <th class="text-end pe-3">–°—É–º–º–∞</th>
            </tr>
          </thead>
          <tbody>
          {% for r in by_store %}
            <tr>
              <td class="ps-3 fw-semibold">{{ r.id_vyruchka__id_magazin__nazvanie }}</td>
              <td class="text-end">{{ r.checks }}</td>
              <td class="text-end">{{ r.qty }}</td>
              <td class="text-end pe-3 fw-semibold">{{ r.amount }}</td>
            </tr>
          {% empty %}
            <tr>
              <td colspan="4">
                <div class="empty-state">
                  <div class="icon" aria-hidden="true">üè¨</div>
                  <div class="fw-semibold mt-2">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div>
                  <div class="text-muted">–ò–∑–º–µ–Ω–∏ –ø–µ—Ä–∏–æ–¥ –∏–ª–∏ –º–∞–≥–∞–∑–∏–Ω</div>
                </div>
              </td>
            </tr>
          {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

{% else %}
  <div class="card soft-card shadow-sm">
    <div class="card-header py-3 d-flex align-items-center justify-content-between">
      <div class="d-flex align-items-center gap-2">
        <span class="badge rounded-pill badge-soft">–°–≤–æ–¥–∫–∞</span>
        <span class="text-muted">–≤—ã—Ä—É—á–∫–∞ –ø–æ –ø—Ä–æ–¥–∞–≤—Ü–∞–º</span>
      </div>
    </div>

    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-hover table-sm align-middle mb-0">
          <thead>
            <tr>
              <th class="ps-3">–ú–∞–≥–∞–∑–∏–Ω</th>
              <th>–ü—Ä–æ–¥–∞–≤–µ—Ü</th>
              <th class="text-end">–ß–µ–∫–æ–≤</th>
              <th class="text-end">–ö–æ–ª-–≤–æ</th>
              <th class="text-end pe-3">–°—É–º–º–∞</th>
            </tr>
          </thead>
          <tbody>
          {% for r in by_seller %}
            <tr>
              <td class="ps-3 fw-semibold">{{ r.id_vyruchka__id_magazin__nazvanie }}</td>
              <td>
                <div class="fw-semibold">
                  {{ r.id_vyruchka__id_rabotnik__familiya }}
                  {{ r.id_vyruchka__id_rabotnik__imya }}
                  {{ r.id_vyruchka__id_rabotnik__otchestvo }}
                </div>
              </td>
              <td class="text-end">{{ r.checks }}</td>
              <td class="text-end">{{ r.qty }}</td>
              <td class="text-end pe-3 fw-semibold">{{ r.amount }}</td>
            </tr>
          {% empty %}
            <tr>
              <td colspan="5">
                <div class="empty-state">
                  <div class="icon" aria-hidden="true">üßë‚Äçüíº</div>
                  <div class="fw-semibold mt-2">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div>
                  <div class="text-muted">–ò–∑–º–µ–Ω–∏ –ø–µ—Ä–∏–æ–¥ –∏–ª–∏ –º–∞–≥–∞–∑–∏–Ω</div>
                </div>
              </td>
            </tr>
          {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
{% endif %}
{% endblock %}
